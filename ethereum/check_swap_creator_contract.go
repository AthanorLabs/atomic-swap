// Copyright 2023 The AthanorLabs/atomic-swap Authors
// SPDX-License-Identifier: LGPL-3.0-only

package contracts

import (
	"bytes"
	"context"
	"errors"
	"fmt"

	ethcommon "github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/ethclient"
)

// expectedSwapCreatorBytecodeHex is generated by deploying an instance of
// SwapCreator.sol and reading back the bytecode. See the unit test
// TestExpectedSwapCreatorBytecodeHex if you need to update this value.
const (
	expectedSwapCreatorBytecodeHex = "6080604052600436106100705760003560e01c8063b32d1b4f1161004e578063b32d1b4f146100d7578063c41e46cf1461010c578063eb84e7f21461012d578063fcaf229c1461016a57600080fd5b80631e6c5acc146100755780635cb969161461009757806387065c49146100b7575b600080fd5b34801561008157600080fd5b50610095610090366004610f67565b61018a565b005b3480156100a357600080fd5b506100956100b2366004610f67565b6103d4565b3480156100c357600080fd5b506100956100d2366004610fb9565b6104f3565b3480156100e357600080fd5b506100f76100f2366004611077565b610830565b60405190151581526020015b60405180910390f35b61011f61011a366004611099565b610900565b604051908152602001610103565b34801561013957600080fd5b5061015d61014836600461110a565b60006020819052908152604090205460ff1681565b6040516101039190611139565b34801561017657600080fd5b50610095610185366004611161565b610be2565b60008260405160200161019d91906111ed565b60408051601f1981840301815291815281516020928301206000818152928390529082205490925060ff16908160038111156101db576101db611123565b036101f957604051631115766760e01b815260040160405180910390fd5b600381600381111561020d5761020d611123565b0361022b5760405163066916a960e01b815260040160405180910390fd5b83516001600160a01b031633146102555760405163148ca24360e11b815260040160405180910390fd5b8360a0015142108015610286575083608001514211806102865750600281600381111561028457610284611123565b145b156102a4576040516332a1860f60e11b815260040160405180910390fd5b6102b2838560600151610cc0565b604051839083907e7c875846b687732a7579c19bb1dade66cd14e9f4f809565e2b2b5e76c72b4f90600090a36000828152602081905260409020805460ff1916600317905560c08401516001600160a01b031661034c57835160e08501516040516001600160a01b039092169181156108fc0291906000818181858888f19350505050158015610346573d6000803e3d6000fd5b506103ce565b60c0840151845160e086015160405163a9059cbb60e01b81526001600160a01b039283166004820152602481019190915291169063a9059cbb906044016020604051808303816000875af11580156103a8573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906103cc91906111fc565b505b50505050565b81602001516001600160a01b0316336001600160a01b03161461040a57604051633471640960e11b815260040160405180910390fd5b6104148282610ce7565b60c08201516001600160a01b031661046c5781602001516001600160a01b03166108fc8360e001519081150290604051600060405180830381858888f19350505050158015610467573d6000803e3d6000fd5b505050565b60c0820151602083015160e084015160405163a9059cbb60e01b81526001600160a01b039283166004820152602481019190915291169063a9059cbb906044016020604051808303816000875af11580156104cb573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061046791906111fc565b5050565b6000600188604051602001610508919061121e565b60408051601f198184030181528282528051602091820120600084529083018083525260ff871690820152606081018590526080810184905260a0016020604051602081039080840390855afa158015610566573d6000803e3d6000fd5b5050506020604051035190508760000151602001516001600160a01b0316816001600160a01b0316146105ac57604051638baa579f60e01b815260040160405180910390fd5b87606001516001600160a01b0316306001600160a01b0316146105e25760405163a710429d60e01b815260040160405180910390fd5b60408089015190516bffffffffffffffffffffffff19606089901b1660208201526001600160e01b031960e088901b166034820152603801604051602081830303815290604052805190602001201461064e5760405163fe16c3c560e01b815260040160405180910390fd5b875161065a9088610ce7565b875160c001516001600160a01b0316610702578760000151602001516001600160a01b03166108fc89602001518a6000015160e0015161069a9190611277565b6040518115909202916000818181858888f193505050501580156106c2573d6000803e3d6000fd5b5060208801516040516001600160a01b0388169180156108fc02916000818181858888f193505050501580156106fc573d6000803e3d6000fd5b50610826565b875160c0810151602080830151908b015160e0909301516001600160a01b039092169263a9059cbb926107359190611277565b6040516001600160e01b031960e085901b1681526001600160a01b03909216600483015260248201526044016020604051808303816000875af1158015610780573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906107a491906111fc565b50875160c00151602089015160405163a9059cbb60e01b81526001600160a01b038981166004830152602482019290925291169063a9059cbb906044016020604051808303816000875af1158015610800573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061082491906111fc565b505b5050505050505050565b600080600181601b7f79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f8179870014551231950b75fc4402da1732fc9bebe197f79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f8179889096040805160008152602081018083529590955260ff909316928401929092526060830152608082015260a0016020604051602081039080840390855afa1580156108dd573d6000803e3d6000fd5b5050604051601f1901516001600160a01b03858116911614925050505b92915050565b60008260000361092357604051637c946ed760e01b815260040160405180910390fd5b6001600160a01b0384166109565734831461095157604051632a9ffab760e21b815260040160405180910390fd5b6109cf565b6040516323b872dd60e01b8152336004820152306024820152604481018490526001600160a01b038516906323b872dd906064016020604051808303816000875af11580156109a9573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906109cd91906111fc565b505b8815806109da575087155b156109f857604051631bc61bed60e11b815260040160405180910390fd5b6001600160a01b038716610a1e576040516208978560e71b815260040160405180910390fd5b851580610a29575084155b15610a4757604051631ffb86f160e21b815260040160405180910390fd5b6000604051806101200160405280336001600160a01b03168152602001896001600160a01b031681526020018b81526020018a81526020018842610a8b919061128a565b815260200187610a9b8a4261128a565b610aa5919061128a565b8152602001866001600160a01b03168152602001858152602001848152509050600081604051602001610ad891906111ed565b60408051601f19818403018152919052805160209091012090506000808281526020819052604090205460ff166003811115610b1657610b16611123565b14610b34576040516339a2986760e11b815260040160405180910390fd5b7f91446ce035ac29998b5473504609a5ef5e961005daba4630a1684b63be848f56818c8c85608001518660a001518760c001518860e00151604051610bb3979695949392919096875260208701959095526040860193909352606085019190915260808401526001600160a01b031660a083015260c082015260e00190565b60405180910390a16000818152602081905260409020805460ff191660011790559a9950505050505050505050565b600081604051602001610bf591906111ed565b60408051601f1981840301815291905280516020909101209050600160008281526020819052604090205460ff166003811115610c3457610c34611123565b14610c5257604051630fe0fb5160e11b815260040160405180910390fd5b81516001600160a01b03163314610c7c5760405163148ca24360e11b815260040160405180910390fd5b600081815260208190526040808220805460ff191660021790555182917f5fc23b25552757626e08b316cc2387ad1bc70ee1594af7204db4ce0c39f5d15f91a25050565b610cca8282610830565b6104ef5760405163abab6bd760e01b815260040160405180910390fd5b600082604051602001610cfa91906111ed565b60408051601f1981840301815291815281516020928301206000818152928390529082205490925060ff1690816003811115610d3857610d38611123565b03610d5657604051631115766760e01b815260040160405180910390fd5b6003816003811115610d6a57610d6a611123565b03610d885760405163066916a960e01b815260040160405180910390fd5b836080015142108015610dad57506002816003811115610daa57610daa611123565b14155b15610dcb5760405163d71d60b560e01b815260040160405180910390fd5b8360a001514210610def5760405163497df9d160e01b815260040160405180910390fd5b610dfd838560400151610cc0565b604051839083907f38d6042dbdae8e73a7f6afbabd3fbe0873f9f5ed3cd71294591c3908c2e65fee90600090a3506000908152602081905260409020805460ff191660031790555050565b604051610120810167ffffffffffffffff81118282101715610e7a57634e487b7160e01b600052604160045260246000fd5b60405290565b6040516080810167ffffffffffffffff81118282101715610e7a57634e487b7160e01b600052604160045260246000fd5b6001600160a01b0381168114610ec657600080fd5b50565b8035610ed481610eb1565b919050565b60006101208284031215610eec57600080fd5b610ef4610e48565b9050610eff82610ec9565b8152610f0d60208301610ec9565b602082015260408201356040820152606082013560608201526080820135608082015260a082013560a0820152610f4660c08301610ec9565b60c082015260e082013560e082015261010080830135818301525092915050565b6000806101408385031215610f7b57600080fd5b610f858484610ed9565b94610120939093013593505050565b803563ffffffff81168114610ed457600080fd5b803560ff81168114610ed457600080fd5b6000806000806000806000878903610240811215610fd657600080fd5b61018080821215610fe657600080fd5b610fee610e80565b9150610ffa8b8b610ed9565b82526101208a013560208301526101408a013560408301526101608a013561102181610eb1565b6060830152909750880135955061103b6101a08901610ec9565b945061104a6101c08901610f94565b93506110596101e08901610fa8565b92506102008801359150610220880135905092959891949750929550565b6000806040838503121561108a57600080fd5b50508035926020909101359150565b600080600080600080600080610100898b0312156110b657600080fd5b883597506020890135965060408901356110cf81610eb1565b9550606089013594506080890135935060a08901356110ed81610eb1565b979a969950949793969295929450505060c08201359160e0013590565b60006020828403121561111c57600080fd5b5035919050565b634e487b7160e01b600052602160045260246000fd5b602081016004831061115b57634e487b7160e01b600052602160045260246000fd5b91905290565b6000610120828403121561117457600080fd5b61117e8383610ed9565b9392505050565b60018060a01b0380825116835280602083015116602084015260408201516040840152606082015160608401526080820151608084015260a082015160a08401528060c08301511660c08401525060e081015160e08301526101008082015181840152505050565b61012081016108fa8284611185565b60006020828403121561120e57600080fd5b8151801515811461117e57600080fd5b600061018082019050611232828451611185565b602083015161012083015260408301516101408301526060909201516001600160a01b03166101609091015290565b634e487b7160e01b600052601160045260246000fd5b818103818111156108fa576108fa611261565b808201808211156108fa576108fa61126156fea26469706673582212208e46497effc64f18265779b96dd009969e1f0fac0b390d6faee990d2944ed19b64736f6c63430008130033" //nolint:lll
)

var (
	errInvalidSwapCreatorContract = errors.New("given contract address does not contain correct SwapCreator code")
)

// CheckSwapCreatorContractCode checks that the bytecode at the given address
// matches the SwapCreator.sol contract.
func CheckSwapCreatorContractCode(
	ctx context.Context,
	ec *ethclient.Client,
	contractAddr ethcommon.Address,
) error {
	code, err := ec.CodeAt(ctx, contractAddr, nil)
	if err != nil {
		return fmt.Errorf("failed to get code at %s: %w", contractAddr, err)
	}

	expectedCode := ethcommon.FromHex(expectedSwapCreatorBytecodeHex)

	if len(code) != len(expectedCode) {
		return fmt.Errorf("length mismatch: %w", errInvalidSwapCreatorContract)
	}

	if !bytes.Equal(expectedCode, code) {
		return errInvalidSwapCreatorContract
	}

	return nil
}
